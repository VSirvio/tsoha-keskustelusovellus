{% extends "layout.html" %}

{% macro indent(level) %}
    {{ "&nbsp;"|safe*(level * 4) }}
{% endmacro %}

{% macro msg_view(message, depth=0) %}
    {{ indent(depth) }}<span class="timestamp">{{ message.time_str }}</span><br>

    {{ indent(depth) }}<b>{{ message.user }}:</b> {{ message.content }}<br>

    {{ indent(depth) }}
    <a href="/reply/{{ message.id }}">Vastaa</a>
    {% if session.username == message.user or is_admin %}
        &nbsp;<a href="/edit/{{ message.id }}">Muokkaa</a>

        <form action="/delete/{{ message.id }}" method="POST" class="link">
            &nbsp;<input type="submit" value="Poista" onclick="return confirm('Poista viesti?')">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        </form>
    {% endif %}
    <br>

    {{ indent(depth) }}
    <b>{{ message.likes }} tykkäys{% if message.likes not in [1, -1] %}tä{% endif %}</b>
    {% if message.liked %}
        <form action="/unlike/{{ message.id }}" method="POST" class="link">
            <input type="submit" value="Poista tykkäys">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        </form>
    {% else %}
        <form action="/like/{{ message.id }}" method="POST" class="link">
            <input type="submit" value="+">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        </form>
        <form action="/dislike/{{ message.id }}" method="POST" class="link">
            <input type="submit" value="-">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        </form>
    {% endif %}
{% endmacro %}

{% block previous %}/subforum/{{ thread.subforum }}{% endblock %}

{% block content %}
    <title>{{ thread.title }} - Viestiketju</title>

    <br>
    <h3 style="display: inline">{{ thread.title }}</h3>
    {% if session.username == thread.username or is_admin %}
        &nbsp;<a href="/thread/edit/{{ thread.id }}" class="title-action">Muokkaa</a>
    {% endif %}
    <br><br>

    {{ msg_view(first_msg) }}<br>

    {% if first_msg.replies %}
        <br>

        <form action="/thread/{{ thread.id }}" method="GET">
            <select name="order_by" onchange="this.form.submit()">
                <option value="newest" {% if order_by == "newest" %}selected{% endif %}>
                    Uusimmat
                </option>
                <option value="oldest" {% if order_by == "oldest" %}selected{% endif %}>
                    Vanhimmat
                </option>
                <option value="most_liked" {% if order_by == "most_liked" %}selected{% endif %}>
                    Tykätyimmät
                </option>
                <option value="most_disliked" {% if order_by == "most_disliked" %}selected{% endif %}>
                    Vihatuimmat
                </option>
            </select>
        </form>

        <hr>
    {% endif %}

    {% for message in (msgs|selectattr("id", "in", first_msg.replies)) recursive %}
        {{ msg_view(message, loop.depth) }}

        <hr>

        {% if message.replies %}
            {{ loop(msgs|selectattr("id", "in", message.replies)) }}
        {% endif %}
    {% endfor %}
{% endblock %}
